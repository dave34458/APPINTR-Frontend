{% extends "library/base.html" %}
{% block title %}Borrows - Educare{% endblock %}
{% block content %}

<style>
.filters-wrapper{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem;margin-bottom:1.5rem}
.filters-wrapper input{padding:.6rem .75rem;font-size:.9rem;border:1px solid #ccc;border-radius:.375rem;transition:all .3s ease}
.filters-wrapper input:focus{outline:none;border-color:#4f46e5;box-shadow:0 0 0 2px rgba(99,102,241,.2);transform:scale(1.02)}
.filters-wrapper input:hover{transform:scale(1.1)}
.w-table{overflow-x:auto;display:block;max-height:350px;border:1px solid #ddd;border-radius:.5rem;box-shadow:0 1px 4px rgba(0,0,0,.05);margin-bottom:2rem}
.w-table table{width:1%;border-collapse:collapse;min-width:100px}
.w-table thead th{position:sticky;top:0;background-color:#f9fafb;z-index:1;padding:.75rem;text-align:left;font-weight:600;border-bottom:1px solid #e5e7eb}
.w-table tbody td{padding:.75rem;border-bottom:1px solid #f1f1f1}
.button{padding:.5rem .9rem;background-color:#4f46e5;color:white;border:none;border-radius:.375rem;cursor:pointer;transition:all .3s ease;transform:scale(1)}
.button:hover{background-color:#4338ca;transform:scale(1.2)}
.button:active{transform:scale(1.01)}
.button-wrapper{margin-top:1rem}
.w-form select,.w-form input[type="date"]{width:100%;padding:.5rem .75rem;border-radius:.375rem;border:1px solid #ccc;margin-top:.25rem;transition:all .3s ease}
.w-form select:hover,.w-form input[type="date"]:hover{transform:scale(1.02)}
.w-form select:focus,.w-form input[type="date"]:focus{outline:none;border-color:#4f46e5;box-shadow:0 0 0 2px rgba(99,102,241,.2);transform:scale(1.02)}
.w-row{display:flex;flex-wrap:wrap;gap:1rem;margin-bottom:1rem}
.w-col{flex:1 1 300px}
select option{transition:background-color .3s ease}
</style>

<div class="w-container">
  <h1 style="margin-bottom:1rem;">Borrow Records</h1>

  <div class="w-form">
    <div class="filters-wrapper">
      <input type="text" id="searchLocation" placeholder="Location" onkeyup="filterTable()">
      <input type="text" id="searchUser" placeholder="User" onkeyup="filterTable()">
      <input type="text" id="searchTitle" placeholder="Title" onkeyup="filterTable()">
      <input type="text" id="searchAuthor" placeholder="Author" onkeyup="filterTable()">
      <input type="text" id="searchGenre" placeholder="Genre" onkeyup="filterTable()">
      <input type="text" id="searchISBN" placeholder="ISBN" onkeyup="filterTable()">
      <input type="text" id="searchLanguage" placeholder="Language" onkeyup="filterTable()">
      <input type="text" id="searchReturnDate" placeholder="Return Date" onkeyup="filterTable()">
    </div>
  </div>

  <div class="w-table">
    <table id="borrowTable">
      <thead>
        <tr>
          <th>Location</th>
          <th>User</th>
          <th>Book Title</th>
          <th>Author</th>
          <th>Published Date</th>
          <th>Genre</th>
          <th>ISBN</th>
          <th>Language</th>
          <th>Return Date</th>
          <th>Date Returned</th>
          <th colspan="2">Action</th>
        </tr>
      </thead>
      <tbody>
        {% for borrow in borrows %}
        <tr>
            <td>{{ borrow.available_book.location }}</td>
            <td>{{ borrow.user.username }}</td>
            <td>{{ borrow.available_book.book.title }}</td>
            <td>{{ borrow.available_book.book.author }}</td>
            <td>{{ borrow.available_book.book.published_date }}</td>
            <td>{{ borrow.available_book.book.genre }}</td>
            <td>{{ borrow.available_book.book.isbn }}</td>
            <td>{{ borrow.available_book.book.language }}</td>
            <td>{{ borrow.return_date }}</td>

          <td>
            {% if borrow.date_returned %}
              {{ borrow.date_returned }}
            {% else %}
              <form method="POST" action="{% url 'library:borrows'%}">
                {% csrf_token %}
              <input type="hidden" name="_method" value="PUT">
                <input type="hidden" name="id" value="{{ borrow.id }}">
                <input type="hidden" name="user" value="{{ borrow.user.id }}">
                <input type="hidden" name="available_book" value="{{ borrow.available_book.id }}">
                <input type="hidden" name="borrow_date" value="{{ borrow.borrow_date }}">
                <input type="hidden" name="return_date" value="{{ borrow.return_date }}">
                <input type="hidden" name="date_returned" value="" id="date_returned">
                <script>document.getElementById('date_returned').value = new Date().toISOString().split('T')[0];</script>
                <button class="button" type="submit">Return</button>
              </form>
            {% endif %}
          </td>
          <td>
            <form method="POST" action="{% url 'library:borrows' %}">
              {% csrf_token %}
              <input type="hidden" name="_method" value="DELETE">
                <input type="hidden" name="id" value="{{ borrow.id }}">
              <button class="button" type="submit">Delete</button>
            </form>
          </td>
          <td>
              <button class="button" onclick="openUpdateModal({{ borrow.id }},'{{ borrow.user.id }}','{{ borrow.available_book.id }}','{{ borrow.borrow_date|default_if_none:'' }}','{{ borrow.return_date|default_if_none:'' }}','{{ borrow.date_returned|default_if_none:'' }}','{{ borrow.available_book.location }}')">Update</button>
          </td>
        </tr>
<div id="modal-{{ borrow.id }}" class="modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:999;align-items:center;justify-content:center">
  <div class="w-form" style="background:#fff;padding:2rem;border-radius:.5rem;width:90%;max-width:500px">
    <form method="POST" action="{% url 'library:borrows' %}">
      {% csrf_token %}
      <input type="hidden" name="_method" value="PUT">
      <input type="hidden" name="id" value="{{ borrow.id }}">

      <div class="w-row">
        <div class="w-col">
          <label for="user-{{ borrow.id }}">User</label>
          <select name="user" id="user-{{ borrow.id }}" required>
            {% for user in users %}
              <option value="{{ user.id }}" {% if borrow.user == user.id %}selected{% endif %}>{{ user.username }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="w-col">
          <label for="location-{{ borrow.id }}">Location</label>
          <select name="location" id="location-{{ borrow.id }}" required onchange="filterModalBooks({{ borrow.id }})">
            <option value="">Select Location</option>
            {% for loc in locations %}
              <option value="{{ loc }}" {% if borrow.available_book.location == loc %}selected{% endif %}>{{ loc }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="w-row">
        <div class="w-col">
          <label for="book-{{ borrow.id }}">Available Book</label>
          <select name="available_book" id="book-{{ borrow.id }}" required>
            <option value="">Select Book</option>
            {% for ab in availablebooks %}
              {% if ab.copy_is_available %}
                <option value="{{ ab.id }}" data-location="{{ ab.location }}" {% if borrow.available_book.id == ab.id %}selected{% endif %}>{{ ab.book.title }}</option>
              {% endif %}
            {% endfor %}
          </select>
        </div>

        <div class="w-col">
          <label for="borrow-{{ borrow.id }}">Borrow Date</label>
          <input type="date" name="borrow_date" id="borrow-{{ borrow.id }}" value="{{ borrow.borrow_date }}" required>
        </div>
      </div>

      <div class="w-row">
        <div class="w-col">
          <label for="return-{{ borrow.id }}">Return Date</label>
          <input type="date" name="return_date" id="return-{{ borrow.id }}" value="{{ borrow.return_date }}" required>
        </div>

        <div class="w-col">
          <label for="returned-{{ borrow.id }}">Date Returned</label>
          <input type="date" name="date_returned" id="returned-{{ borrow.id }}" value="{{ borrow.date_returned }}">
        </div>
      </div>

      <div class="w-row" style="justify-content:space-between">
        <div class="w-col">
          <button class="button" type="submit" style="width:100%">Save</button>
        </div>
        <div class="w-col">
          <button class="button" type="button" onclick="closeModal({{ borrow.id }})" style="width:100%">Cancel</button>
        </div>
      </div>
    </form>
  </div>
</div>
        {% empty %}
        <tr><td colspan="12">No borrowed books.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <h2>Enter a New Borrow Record</h2>
  <form method="POST" class="w-form">
    {% csrf_token %}
    <div class="w-row">
      <div class="w-col">
        <label for="user">Select User:</label>
        <select id="user" name="user" required>
          <option value="">Select User</option>
          {% for user in users %}
            <option value="{{ user.id }}">{{ user.username }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="w-col">
        <label for="location">Select Location:</label>
        <select id="location" name="location">
          <option value="">Select Location</option>
          {% for loc in locations %}
            <option value="{{ loc }}">{{ loc }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
    <div class="w-row">
      <div class="w-col">
        <label for="available_book">Available Book:</label>
            <select id="available_book" name="available_book" required>
              <option value="">Select Book</option>
              {% for ab in availablebooks %}
                {% if ab.copy_is_available %}
                  <option value="{{ ab.id }}" data-location="{{ ab.location }}" style="display:none">{{ ab.book.title }}</option>
                {% endif %}
              {% endfor %}
            </select>
      </div>
      <div class="w-col">
        <label for="return_date">Return Date:</label>
        <input type="date" id="return_date" name="return_date" required>
      </div>
    </div>
    <div class="button-wrapper">
      <button type="submit" class="button">Borrow Book</button>
    </div>
  </form>
</div>
<script>
function filterModalBooks(id) {
  const locationValue = document.getElementById(`location-${id}`).value.toLowerCase();
  const bookSelect = document.getElementById(`book-${id}`);
  Array.from(bookSelect.options).forEach(opt => {
    if (!opt.value) return;
    opt.style.display = opt.dataset.location.toLowerCase() === locationValue ? 'block' : 'none';
  });
  if (bookSelect.selectedOptions.length && bookSelect.selectedOptions[0].style.display === 'none') {
    bookSelect.value = '';
  }
}
function filterTable(){
const l=document.getElementById('searchLocation').value.toUpperCase(),u=document.getElementById('searchUser').value.toUpperCase(),t=document.getElementById('searchTitle').value.toUpperCase(),a=document.getElementById('searchAuthor').value.toUpperCase(),g=document.getElementById('searchGenre').value.toUpperCase(),i=document.getElementById('searchISBN').value.toUpperCase(),lan=document.getElementById('searchLanguage').value.toUpperCase(),r=document.getElementById('searchReturnDate').value.toUpperCase();const rows=document.querySelector("#borrowTable tbody").rows;for(let x=0;x<rows.length;x++){const row=rows[x],lc=row.cells[0].textContent.toUpperCase(),uc=row.cells[1].textContent.toUpperCase(),tc=row.cells[2].textContent.toUpperCase(),ac=row.cells[3].textContent.toUpperCase(),gc=row.cells[5].textContent.toUpperCase(),ic=row.cells[6].textContent.toUpperCase(),lcg=row.cells[7].textContent.toUpperCase(),rc=row.cells[8].textContent.toUpperCase();row.style.display=(lc.indexOf(l)>-1||!l)&&(uc.indexOf(u)>-1||!u)&&(tc.indexOf(t)>-1||!t)&&(ac.indexOf(a)>-1||!a)&&(gc.indexOf(g)>-1||!g)&&(ic.indexOf(i)>-1||!i)&&(lcg.indexOf(lan)>-1||!lan)&&(rc.indexOf(r)>-1||!r)?"":"none"}}

document.getElementById('location').addEventListener('change',function(){let loc=this.value.toLowerCase(),bookSelect=document.getElementById('available_book');Array.from(bookSelect.options).forEach(opt=>{if(!opt.value)return;opt.style.display=opt.dataset.location.toLowerCase()===loc?'block':'none'});bookSelect.value=''})

document.addEventListener('DOMContentLoaded',()=>{const returnDateInput=document.getElementById('return_date');const today=new Date();today.setDate(today.getDate()+5);const day=String(today.getDate()).padStart(2,'0');const month=String(today.getMonth()+1).padStart(2,'0');const year=today.getFullYear();returnDateInput.value=`${year}-${month}-${day}`})

function openUpdateModal(id,u,b,bd,rd,dret){document.getElementById(`user-${id}`).value=u||'';document.getElementById(`book-${id}`).value=b||'';document.getElementById(`borrow-${id}`).value=bd||'';document.getElementById(`return-${id}`).value=rd||'';document.getElementById(`returned-${id}`).value=dret||'';document.getElementById(`modal-${id}`).style.display='flex'}
function closeModal(id){document.getElementById(`modal-${id}`).style.display='none'}
function openUpdateModal(id,u,b,bd,rd,dret,loc){
    document.getElementById(`user-${id}`).value=u||''
    document.getElementById(`borrow-${id}`).value=bd||''
    document.getElementById(`return-${id}`).value=rd||''
    document.getElementById(`returned-${id}`).value=dret||''
    document.getElementById(`location-${id}`).value=loc||''
    filterModalBooks(id)
    document.getElementById(`book-${id}`).value=b||''
    document.getElementById(`modal-${id}`).style.display='flex'
}

function filterModalBooks(id) {
  const locationValue = document.getElementById(`location-${id}`).value.toLowerCase();
  const bookSelect = document.getElementById(`book-${id}`);
  Array.from(bookSelect.options).forEach(opt => {
    if (!opt.value) return;
    opt.style.display = opt.dataset.location.toLowerCase() === locationValue ? 'block' : 'none';
  });
  if (bookSelect.selectedOptions.length && bookSelect.selectedOptions[0].style.display === 'none') {
    bookSelect.value = '';
  }
}

</script>

{% endblock %}
